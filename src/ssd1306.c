#include "ssd1306.h"
#include "i2c.h"
#include "framework.h"



const char __6x14[2 * 95 * 6] = {
  /* Top Half */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*  32 space */
  0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, /*  33 exclam */
  0x00, 0x00, 0x1e, 0x00, 0x1e, 0x00, /*  34 quotedbl */
  0x00, 0x20, 0xfc, 0x20, 0xfc, 0x20, /*  35 numbersign */
  0x30, 0x48, 0x88, 0xfc, 0x88, 0x30, /*  36 dollar */
  0x18, 0x24, 0xa4, 0x78, 0x10, 0x0c, /*  37 percent */
  0x00, 0xb8, 0xc4, 0x44, 0x38, 0x80, /*  38 ampersand */
  0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, /*  39 quotesingle */
  0x00, 0x00, 0xe0, 0x18, 0x04, 0x02, /*  40 parenleft */
  0x00, 0x02, 0x04, 0x18, 0xe0, 0x00, /*  41 parenright */
  0x00, 0x20, 0x40, 0xf0, 0x40, 0x20, /*  42 asterisk */
  0x00, 0x80, 0x80, 0xf0, 0x80, 0x80, /*  43 plus */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*  44 comma */
  0x00, 0x80, 0x80, 0x80, 0x80, 0x80, /*  45 hyphen */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*  46 period */
  0x00, 0x00, 0x00, 0xe0, 0x18, 0x06, /*  47 slash */
  0xf0, 0x08, 0x04, 0x04, 0x08, 0xf0, /*  48 zero */
  0x00, 0x10, 0x08, 0xfc, 0x00, 0x00, /*  49 one */
  0x18, 0x04, 0x04, 0x04, 0xc4, 0x38, /*  50 two */
  0x04, 0x04, 0x44, 0x64, 0x54, 0x8c, /*  51 three */
  0x00, 0xc0, 0x30, 0x08, 0xfc, 0x00, /*  52 four */
  0x7c, 0x24, 0x24, 0x24, 0x24, 0xc4, /*  53 five */
  0xf0, 0x88, 0x44, 0x44, 0x44, 0x80, /*  54 six */
  0x04, 0x04, 0x04, 0xc4, 0x34, 0x0c, /*  55 seven */
  0x18, 0xa4, 0x44, 0x44, 0xa4, 0x18, /*  56 eight */
  0x78, 0x84, 0x84, 0x84, 0x44, 0xf8, /*  57 nine */
  0x00, 0x00, 0x20, 0x70, 0x20, 0x00, /*  58 colon */
  0x00, 0x00, 0x60, 0x60, 0x00, 0x00, /*  59 semicolon */
  0x00, 0x80, 0x40, 0x20, 0x10, 0x08, /*  60 less */
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, /*  61 equal */
  0x00, 0x08, 0x10, 0x20, 0x40, 0x80, /*  62 greater */
  0x18, 0x04, 0x04, 0xc4, 0x24, 0x18, /*  63 question */
  0xf0, 0x08, 0xe4, 0x14, 0x14, 0xf8, /*  64 at */
  0xf0, 0x88, 0x84, 0x84, 0x88, 0xf0, /*  65 A */
  0xfc, 0x44, 0x44, 0x44, 0xa8, 0x10, /*  66 B */
  0xf8, 0x04, 0x04, 0x04, 0x04, 0x18, /*  67 C */
  0xfc, 0x04, 0x04, 0x04, 0x08, 0xf0, /*  68 D */
  0xfc, 0x44, 0x44, 0x44, 0x04, 0x04, /*  69 E */
  0xfc, 0x44, 0x44, 0x44, 0x04, 0x04, /*  70 F */
  0xf8, 0x04, 0x04, 0x84, 0x84, 0x98, /*  71 G */
  0xfc, 0x40, 0x40, 0x40, 0x40, 0xfc, /*  72 H */
  0x00, 0x04, 0x04, 0xfc, 0x04, 0x04, /*  73 I */
  0x00, 0x00, 0x00, 0x04, 0xfc, 0x04, /*  74 J */
  0xfc, 0x40, 0xa0, 0x10, 0x08, 0x04, /*  75 K */
  0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, /*  76 L */
  0xfc, 0x18, 0x60, 0x60, 0x18, 0xfc, /*  77 M */
  0xfc, 0x30, 0x40, 0x80, 0x00, 0xfc, /*  78 N */
  0xf8, 0x04, 0x04, 0x04, 0x04, 0xf8, /*  79 O */
  0xfc, 0x84, 0x84, 0x84, 0x84, 0x78, /*  80 P */
  0xf8, 0x04, 0x04, 0x04, 0x04, 0xf8, /*  81 Q */
  0xfc, 0x84, 0x84, 0x84, 0x84, 0x78, /*  82 R */
  0x38, 0x44, 0x44, 0x84, 0x84, 0x18, /*  83 S */
  0x04, 0x04, 0x04, 0xfc, 0x04, 0x04, /*  84 T */
  0xfc, 0x00, 0x00, 0x00, 0x00, 0xfc, /*  85 U */
  0x3c, 0xc0, 0x00, 0x00, 0xc0, 0x3c, /*  86 V */
  0x00, 0xfc, 0x00, 0x00, 0x00, 0xfc, /*  87 W */
  0x0c, 0x30, 0xc0, 0xc0, 0x30, 0x0c, /*  88 X */
  0x00, 0x1c, 0x60, 0x80, 0x60, 0x1c, /*  89 Y */
  0x04, 0x04, 0x84, 0x64, 0x14, 0x0c, /*  90 Z */
  0x00, 0x00, 0xfe, 0x02, 0x02, 0x02, /*  91 bracketleft */
  0x06, 0x18, 0xe0, 0x00, 0x00, 0x00, /*  92 backslash */
  0x00, 0x02, 0x02, 0x02, 0xfe, 0x00, /*  93 bracketright */
  0x08, 0x04, 0x02, 0x02, 0x04, 0x08, /*  94 asciicircum */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*  95 underscore */
  0x00, 0x00, 0x02, 0x04, 0x08, 0x00, /*  96 grave */
  0x40, 0x20, 0x20, 0x20, 0x20, 0xc0, /*  97 a */
  0xfc, 0x40, 0x20, 0x20, 0x20, 0xc0, /*  98 b */
  0xc0, 0x20, 0x20, 0x20, 0x20, 0x40, /*  99 c */
  0xc0, 0x20, 0x20, 0x20, 0x40, 0xfc, /* 100 d */
  0xc0, 0x20, 0x20, 0x20, 0x20, 0xc0, /* 101 e */
  0x40, 0x40, 0xf8, 0x44, 0x44, 0x08, /* 102 f */
  0xc0, 0x20, 0x20, 0x20, 0xc0, 0x20, /* 103 g */
  0xfc, 0x40, 0x20, 0x20, 0x20, 0xc0, /* 104 h */
  0x00, 0x00, 0x20, 0xec, 0x00, 0x00, /* 105 i */
  0x00, 0x00, 0x00, 0x00, 0x20, 0xec, /* 106 j */
  0xfc, 0x00, 0x80, 0x40, 0x20, 0x00, /* 107 k */
  0x00, 0x00, 0x04, 0xfc, 0x00, 0x00, /* 108 l */
  0x00, 0xe0, 0x20, 0xc0, 0x20, 0xc0, /* 109 m */
  0xe0, 0x40, 0x20, 0x20, 0x20, 0xc0, /* 110 n */
  0xc0, 0x20, 0x20, 0x20, 0x20, 0xc0, /* 111 o */
  0xe0, 0x40, 0x20, 0x20, 0x20, 0xc0, /* 112 p */
  0xc0, 0x20, 0x20, 0x20, 0x40, 0xe0, /* 113 q */
  0xe0, 0x40, 0x20, 0x20, 0x20, 0xc0, /* 114 r */
  0x40, 0xa0, 0x20, 0x20, 0x20, 0x40, /* 115 s */
  0x20, 0x20, 0xfc, 0x20, 0x20, 0x00, /* 116 t */
  0xe0, 0x00, 0x00, 0x00, 0x00, 0xe0, /* 117 u */
  0x00, 0xe0, 0x00, 0x00, 0x00, 0xe0, /* 118 v */
  0x00, 0xe0, 0x00, 0x80, 0x00, 0xe0, /* 119 w */
  0x60, 0x80, 0x00, 0x00, 0x80, 0x60, /* 120 x */
  0xe0, 0x00, 0x00, 0x00, 0x00, 0xe0, /* 121 y */
  0x20, 0x20, 0x20, 0xa0, 0x60, 0x20, /* 122 z */
  0x00, 0x00, 0x80, 0x7c, 0x02, 0x02, /* 123 braceleft */
  0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, /* 124 bar */
  0x00, 0x02, 0x02, 0x7c, 0x80, 0x00, /* 125 braceright */
  0x0c, 0x02, 0x04, 0x08, 0x10, 0x0c, /* 126 asciitilde */
  /* Bottom Half */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*  32 space */
  0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, /*  33 exclam */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*  34 quotedbl */
  0x00, 0x01, 0x0f, 0x01, 0x0f, 0x01, /*  35 numbersign */
  0x06, 0x08, 0x08, 0x1f, 0x08, 0x07, /*  36 dollar */
  0x0c, 0x02, 0x07, 0x09, 0x09, 0x06, /*  37 percent */
  0x07, 0x08, 0x08, 0x05, 0x06, 0x09, /*  38 ampersand */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*  39 quotesingle */
  0x00, 0x00, 0x03, 0x0c, 0x10, 0x20, /*  40 parenleft */
  0x00, 0x20, 0x10, 0x0c, 0x03, 0x00, /*  41 parenright */
  0x00, 0x02, 0x01, 0x07, 0x01, 0x02, /*  42 asterisk */
  0x00, 0x00, 0x00, 0x07, 0x00, 0x00, /*  43 plus */
  0x00, 0x00, 0x24, 0x1c, 0x00, 0x00, /*  44 comma */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*  45 hyphen */
  0x00, 0x00, 0x08, 0x1c, 0x08, 0x00, /*  46 period */
  0x30, 0x0c, 0x03, 0x00, 0x00, 0x00, /*  47 slash */
  0x03, 0x04, 0x08, 0x08, 0x04, 0x03, /*  48 zero */
  0x00, 0x08, 0x08, 0x0f, 0x08, 0x08, /*  49 one */
  0x08, 0x0c, 0x0a, 0x09, 0x08, 0x08, /*  50 two */
  0x06, 0x08, 0x08, 0x08, 0x08, 0x07, /*  51 three */
  0x03, 0x02, 0x02, 0x02, 0x0f, 0x02, /*  52 four */
  0x06, 0x08, 0x08, 0x08, 0x08, 0x07, /*  53 five */
  0x07, 0x08, 0x08, 0x08, 0x08, 0x07, /*  54 six */
  0x00, 0x0c, 0x03, 0x00, 0x00, 0x00, /*  55 seven */
  0x07, 0x08, 0x08, 0x08, 0x08, 0x07, /*  56 eight */
  0x06, 0x08, 0x08, 0x08, 0x04, 0x03, /*  57 nine */
  0x00, 0x00, 0x04, 0x0e, 0x04, 0x00, /*  58 colon */
  0x00, 0x00, 0x12, 0x0e, 0x00, 0x00, /*  59 semicolon */
  0x00, 0x00, 0x01, 0x02, 0x04, 0x08, /*  60 less */
  0x01, 0x01, 0x01, 0x01, 0x01, 0x01, /*  61 equal */
  0x00, 0x08, 0x04, 0x02, 0x01, 0x00, /*  62 greater */
  0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, /*  63 question */
  0x03, 0x04, 0x09, 0x0a, 0x0a, 0x0b, /*  64 at */
  0x0f, 0x00, 0x00, 0x00, 0x00, 0x0f, /*  65 A */
  0x0f, 0x08, 0x08, 0x08, 0x04, 0x03, /*  66 B */
  0x07, 0x08, 0x08, 0x08, 0x08, 0x06, /*  67 C */
  0x0f, 0x08, 0x08, 0x08, 0x04, 0x03, /*  68 D */
  0x0f, 0x08, 0x08, 0x08, 0x08, 0x08, /*  69 E */
  0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, /*  70 F */
  0x07, 0x08, 0x08, 0x08, 0x04, 0x0f, /*  71 G */
  0x0f, 0x00, 0x00, 0x00, 0x00, 0x0f, /*  72 H */
  0x00, 0x08, 0x08, 0x0f, 0x08, 0x08, /*  73 I */
  0x06, 0x08, 0x08, 0x08, 0x07, 0x00, /*  74 J */
  0x0f, 0x00, 0x00, 0x01, 0x02, 0x0c, /*  75 K */
  0x0f, 0x08, 0x08, 0x08, 0x08, 0x08, /*  76 L */
  0x0f, 0x00, 0x00, 0x00, 0x00, 0x0f, /*  77 M */
  0x0f, 0x00, 0x00, 0x00, 0x03, 0x0f, /*  78 N */
  0x07, 0x08, 0x08, 0x08, 0x08, 0x07, /*  79 O */
  0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, /*  80 P */
  0x07, 0x09, 0x09, 0x0a, 0x1c, 0x27, /*  81 Q */
  0x0f, 0x00, 0x00, 0x01, 0x02, 0x0c, /*  82 R */
  0x06, 0x08, 0x08, 0x08, 0x08, 0x07, /*  83 S */
  0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, /*  84 T */
  0x07, 0x08, 0x08, 0x08, 0x08, 0x07, /*  85 U */
  0x00, 0x01, 0x0e, 0x0e, 0x01, 0x00, /*  86 V */
  0x00, 0x07, 0x08, 0x07, 0x08, 0x07, /*  87 W */
  0x0c, 0x03, 0x00, 0x00, 0x03, 0x0c, /*  88 X */
  0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, /*  89 Y */
  0x0c, 0x0b, 0x08, 0x08, 0x08, 0x08, /*  90 Z */
  0x00, 0x00, 0x3f, 0x20, 0x20, 0x20, /*  91 bracketleft */
  0x00, 0x00, 0x00, 0x03, 0x0c, 0x30, /*  92 backslash */
  0x00, 0x20, 0x20, 0x20, 0x3f, 0x00, /*  93 bracketright */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*  94 asciicircum */
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, /*  95 underscore */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*  96 grave */
  0x06, 0x09, 0x09, 0x09, 0x09, 0x0f, /*  97 a */
  0x0f, 0x04, 0x08, 0x08, 0x08, 0x07, /*  98 b */
  0x07, 0x08, 0x08, 0x08, 0x08, 0x04, /*  99 c */
  0x07, 0x08, 0x08, 0x08, 0x04, 0x0f, /* 100 d */
  0x07, 0x09, 0x09, 0x09, 0x09, 0x05, /* 101 e */
  0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, /* 102 f */
  0x19, 0x26, 0x2a, 0x2a, 0x29, 0x10, /* 103 g */
  0x0f, 0x00, 0x00, 0x00, 0x00, 0x0f, /* 104 h */
  0x00, 0x08, 0x08, 0x0f, 0x08, 0x08, /* 105 i */
  0x00, 0x18, 0x20, 0x20, 0x20, 0x1f, /* 106 j */
  0x0f, 0x01, 0x01, 0x02, 0x04, 0x08, /* 107 k */
  0x00, 0x08, 0x08, 0x0f, 0x08, 0x08, /* 108 l */
  0x00, 0x0f, 0x00, 0x07, 0x00, 0x0f, /* 109 m */
  0x0f, 0x00, 0x00, 0x00, 0x00, 0x0f, /* 110 n */
  0x07, 0x08, 0x08, 0x08, 0x08, 0x07, /* 111 o */
  0x3f, 0x04, 0x08, 0x08, 0x08, 0x07, /* 112 p */
  0x07, 0x08, 0x08, 0x08, 0x04, 0x3f, /* 113 q */
  0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, /* 114 r */
  0x04, 0x08, 0x09, 0x09, 0x0a, 0x04, /* 115 s */
  0x00, 0x00, 0x07, 0x08, 0x08, 0x04, /* 116 t */
  0x07, 0x08, 0x08, 0x08, 0x04, 0x0f, /* 117 u */
  0x00, 0x00, 0x03, 0x0c, 0x03, 0x00, /* 118 v */
  0x00, 0x07, 0x08, 0x07, 0x08, 0x07, /* 119 w */
  0x0c, 0x02, 0x01, 0x01, 0x02, 0x0c, /* 120 x */
  0x13, 0x24, 0x24, 0x24, 0x22, 0x1f, /* 121 y */
  0x08, 0x0c, 0x0b, 0x08, 0x08, 0x08, /* 122 z */
  0x00, 0x00, 0x00, 0x1f, 0x20, 0x20, /* 123 braceleft */
  0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, /* 124 bar */
  0x00, 0x20, 0x20, 0x1f, 0x00, 0x00, /* 125 braceright */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00  /* 126 asciitilde */
};


static const unsigned char SSD1306_INIT[] = {
  SSD1306_CMD_STREAM,
  SSD1306_SET_MPLEX,     0x3f,
  SSD1306_DISP_OFFSET,   0x00,
  SSD1306_DISP_START_LINE(0),
  SSD1306_SEG_REMAP(1), // was originally 1
  SSD1306_COM_REVERSE,
  //SSD1306_COM_FORWARD,
  SSD1306_COM_HW_CONF,   0x12,
  SSD1306_SET_CONTRAST,  0x7F,
  SSD1306_ENTIRE_ON_RAM,
  SSD1306_NORMAL_DISP,
  SSD1306_CLOCK_DIVIDE,  0x80,
  SSD1306_CHARGE_PUMP,   SSD1306_PUMP_ON,
  SSD1306_DISPLAY_ON,
  SSD1306_SET_COL_ADDR,  0x00, 0x7f,
  SSD1306_SET_PAGE_ADDR, 0x00, 0x07,
  SSD1306_SET_ADDR_MODE, SSD1306_ADDR_MODE_HORZ
};

static const unsigned SSD1306_INIT_COUNT = sizeof(SSD1306_INIT) / sizeof(SSD1306_INIT[0]);

static void __SSD1306_push_char(char c, unsigned half) {
  unsigned k = 0;

  unsigned char_index = (unsigned)c - 32;
  unsigned row = char_index * 6;
  unsigned slice = half * 95 * 6;
  
  while (k < 6) {
    unsigned char row_byte = __6x14[slice + row + k];

    I2C_push(row_byte);
    
    k++;
  }
}

#define char_buffer_len 8
typedef char char_buffer_t[char_buffer_len];

static void __SSD1306_num_to_text(unsigned x, char_buffer_t out, unsigned char *offset) {
  *offset = 0;
  out[char_buffer_len - 1] = '\0';

  if (x <= SSD1306_MAX_PRINTABLE_VALUE) {
    unsigned back_inserter = char_buffer_len - 2;
    unsigned y = x;
    
    while (y > 0) {
      unsigned digit = y % 10;

      out[back_inserter] = (char)(digit + 0x30);
      
      back_inserter--;
      
      y /= 10;
    }
    
    *offset = back_inserter + 1;
  } else {
    *offset = 0xFF; // failure
  }
}

static void __SSD1306_print_num(double num) {
  volatile double modf = num - (double)((unsigned) num);
  
  volatile unsigned mulp = (unsigned)(100.0 * modf);
  volatile unsigned unum = (unsigned)num;

  char_buffer_t radix_right;
  unsigned char radix_right_ofs = 0;
  __SSD1306_num_to_text(mulp, radix_right, &radix_right_ofs);

  char_buffer_t radix_left;
  unsigned char radix_left_ofs = 0;
  __SSD1306_num_to_text(unum, radix_left, &radix_left_ofs);

  char concat[24];
  unsigned i = 0;

  char* ptr = &radix_left[radix_left_ofs];
  
  while (*ptr) {
    concat[i] = *ptr;
    i++;
    ptr++;
  }

  concat[i] = '.';
  i++;
  
  ptr = &radix_right[radix_right_ofs];

  while (*ptr) {
    concat[i] = *ptr;
    i++;
    ptr++;
  }

  if (i < 24) {
    concat[i] = '\0';

    SSD1306_set_col_range(0, (i) * 6);
    SSD1306_set_page_range(0, 3);
    
    SSD1306_write_text(concat);
  }
}

static void __SSD1306_clear_screen() {
  char blank[128];

  for (volatile unsigned i = 0; i < 127; ++i) {
    blank[i] = ' ';
  }

  blank[127] = '\0';
  
  for (unsigned k = 0; k < 7; ++k) {
    SSD1306_set_page(k);
    SSD1306_write_text(blank);
  }
}

volatile struct  {
  bool clear_screen;
  double print_val;
} static SSD1306_CMD = {
  false,
  0.0
};


void SSD1306_init() {
  I2C_cat(SSD1306_INIT, SSD1306_INIT_COUNT);
  I2C_conset_start();
  I2C_block();
}

void SSD1306_write_text(const char* text) {
  unsigned length = strlen(text);

  I2C_push(SSD1306_DATA_STREAM);
    
  unsigned i = 0; 
  while (i < length) {
    __SSD1306_push_char(text[i], 0);  
    i++;
  }

  // I2C_conset_start();
  // I2C_block();
  
  i = 0;
  while (i < length) {
    __SSD1306_push_char(text[i], 1);
    i++;
  }

  I2C_conset_start();
  I2C_block();
}

void SSD1306_print_num(double num) {
  SSD1306_CMD.print_val = num;
}

void SSD1306_clear_screen() {
  SSD1306_CMD.clear_screen = true;
}

void SSD1306_set_page(unsigned row) {
  SSD1306_set_page_range(row, SSD1306_PAGE_END);
}

void SSD1306_set_col(unsigned col) {
  SSD1306_set_page_range(col, SSD1306_COL_END);
}

void SSD1306_set_page_range(unsigned start, unsigned end) {
  I2C_push(SSD1306_CMD_STREAM);
  I2C_push(SSD1306_SET_PAGE_ADDR);

  I2C_push((unsigned char)(start & SSD1306_PAGE_END));
  I2C_push((unsigned char)(end &SSD1306_PAGE_END));

  I2C_conset_start();
  I2C_block();
}

void SSD1306_set_col_range(unsigned start, unsigned end) {
  I2C_push(SSD1306_CMD_STREAM);
  I2C_push(SSD1306_SET_COL_ADDR);

  I2C_push((unsigned char)(start & SSD1306_COL_END));
  I2C_push((unsigned char)(end & SSD1306_COL_END));
  
  I2C_conset_start();
  I2C_block();
}

void SSD1306_display_thread() {
  while (true) {
    bsem_enter(&LOCK);

    if (SSD1306_CMD.clear_screen) {
      __SSD1306_clear_screen();
      SSD1306_CMD.clear_screen = false;
    }

    __SSD1306_print_num(SSD1306_CMD.print_val);

    bsem_leave(&LOCK);

    msleep(50);
  }
}
